<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="zoraxy.csrf.Token" content="{{.csrfToken}}">
    <title>Proxy Protocol Plugin</title>
    <style>
        :root {
            --primary-color: #198754;
            --primary-hover: #157347;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --secondary-color: #6c757d;
            --border-color: #dee2e6;
            --border-radius: 8px;
            --border-radius-sm: 6px;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --transition: all 0.15s ease-in-out;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background: var(--bs-body-bg, #f8f9fa);
            color: var(--bs-body-color, #212529);
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Card Components */
        .card {
            background: var(--bs-card-bg, white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bs-secondary-bg, #f8f9fa);
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-subtitle {
            margin: 0;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .nested-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .nested-card .card-header {
            background: var(--bs-tertiary-bg, #f8f9fa);
            font-size: 1.1rem;
            font-weight: 500;
            padding: 1rem 1.25rem;
        }

        /* Alert Components */
        .alert {
            padding: 0.875rem 1.25rem;
            margin: 1.5rem 0;
            border: 1px solid transparent;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .alert-success {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }

        .alert-danger {
            color: #842029;
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }

        .alert-secondary {
            color: #41464b;
            background-color: #e2e3e5;
            border-color: #d3d6d8;
        }

        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            text-decoration: none;
            transition: var(--transition);
            min-width: 120px;
        }

        .btn-success {
            color: white;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-success:hover:not(:disabled) {
            background-color: var(--primary-hover);
            border-color: #146c43;
            transform: translateY(-1px);
        }

        .btn-danger {
            color: white;
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: var(--danger-hover);
            border-color: #bd2130;
            transform: translateY(-1px);
        }

        .btn-secondary {
            color: white;
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            transform: none;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-muted { color: var(--secondary-color); }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .me-2 { margin-right: 0.5rem; }

        .list-unstyled {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .list-unstyled li {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .version-info {
            font-size: 0.85rem;
            padding: 0.5rem;
            background: var(--bs-tertiary-bg, #f8f9fa);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }

        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .container {
                padding: 0;
            }

            .card-header,
            .card-body,
            .nested-card .card-header {
                padding: 1rem;
            }

            .btn {
                min-width: 100px;
                padding: 0.625rem 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .card-title {
                font-size: 1.1rem;
            }

            .nested-card {
                margin-bottom: 1rem;
            }
        }

        /* Dark mode support (if Zoraxy supports it) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bs-body-bg: #1a1a1a;
                --bs-body-color: #e9ecef;
                --bs-card-bg: #2d2d2d;
                --bs-secondary-bg: #404040;
                --bs-tertiary-bg: #3a3a3a;
                --border-color: #495057;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">
                    <span>üåê</span>
                    Proxy Protocol Plugin
                </h4>
                <p class="card-subtitle">HAProxy Compatible Proxy Protocol Support for Zoraxy</p>
            </div>

            <div class="card-body">
                <!-- Version Info -->
                <div class="text-center mb-4">
                    <div class="version-info">
                        <small class="text-muted" id="version">Version: Loading...</small>
                    </div>
                </div>

                <!-- Status Alert -->
                <div id="status" class="alert alert-secondary loading" role="alert">
                    <span>‚è≥</span>
                    <span>Status: Loading...</span>
                </div>

                <!-- Configuration Section -->
                <div class="nested-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title">
                            <span>‚öôÔ∏è</span>
                            Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>This plugin adds support for the Proxy Protocol, which allows preserving client connection information when traffic passes through a Layer 4 proxy like HAProxy.</p>

                        <div class="text-center">
                            <button id="toggleButton" class="btn btn-secondary" onclick="toggleProxyProtocol()" disabled>
                                <span>‚è≥</span>
                                <span>Loading...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- About Section -->
                <div class="nested-card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <span>‚ÑπÔ∏è</span>
                            About
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>The Proxy Protocol is used to convey connection information for connections proxied through a proxy or load balancer. It supports both version 1 (text-based) and version 2 (binary) of the protocol.</p>

                        <p><strong>When enabled, this plugin will:</strong></p>
                        <ul class="list-unstyled">
                            <li>
                                <span>‚úÖ</span>
                                <span>Detect incoming Proxy Protocol headers</span>
                            </li>
                            <li>
                                <span>‚úÖ</span>
                                <span>Extract original client IP and port information</span>
                            </li>
                            <li>
                                <span>‚úÖ</span>
                                <span>Set appropriate X-Forwarded-For and X-Real-IP headers</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ProxyProtocolPlugin {
            constructor() {
                this.currentEnabled = false;
                this.elements = {
                    toggleButton: document.getElementById('toggleButton'),
                    status: document.getElementById('status'),
                    version: document.getElementById('version')
                };
                this.csrfToken = document.querySelector('meta[name="zoraxy.csrf.Token"]').getAttribute('content');
                this.init();
            }

            init() {
                this.loadStatus();
            }

            updateToggleButton(enabled, disabled = false) {
                this.currentEnabled = enabled;
                const button = this.elements.toggleButton;

                if (disabled) {
                    this.setButtonState('‚ö†Ô∏è', 'Unavailable', 'btn btn-secondary', true);
                } else {
                    if (enabled) {
                        this.setButtonState('‚èπÔ∏è', 'Disable', 'btn btn-danger', false);
                    } else {
                        this.setButtonState('‚ñ∂Ô∏è', 'Enable', 'btn btn-success', false);
                    }
                }
            }

            setButtonState(icon, text, className, disabled) {
                const button = this.elements.toggleButton;
                button.innerHTML = `<span>${icon}</span><span>${text}</span>`;
                button.className = className;
                button.disabled = disabled;
            }

            updateStatusAlert(status) {
                const statusElement = this.elements.status;
                statusElement.className = 'alert';
                statusElement.classList.remove('loading');

                let icon, text, alertClass;

                switch(status) {
                    case 'Enabled':
                        icon = '‚úÖ';
                        text = 'Status: Enabled';
                        alertClass = 'alert-success';
                        break;
                    case 'Disabled':
                        icon = '‚è∏Ô∏è';
                        text = 'Status: Disabled';
                        alertClass = 'alert-secondary';
                        break;
                    case 'Error':
                        icon = '‚ùå';
                        text = 'Status: Error';
                        alertClass = 'alert-danger';
                        break;
                    default:
                        icon = '‚è≥';
                        text = 'Status: Loading...';
                        alertClass = 'alert-secondary';
                        statusElement.classList.add('loading');
                }

                statusElement.className = `alert ${alertClass}`;
                statusElement.innerHTML = `<span>${icon}</span><span>${text}</span>`;
            }

            async loadStatus() {
                try {
                    const response = await fetch('./api/status');

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    this.updateStatusAlert(data.status);
                    this.elements.version.textContent = `Version: ${data.version || 'Unknown'}`;

                    const isError = data.status === 'Error';
                    this.updateToggleButton(data.enabled, isError);

                } catch (error) {
                    console.error('Failed to load status:', error);
                    this.updateStatusAlert('Error');
                    this.elements.version.textContent = 'Version: Unknown';
                    this.updateToggleButton(false, true);
                }
            }

            async toggleProxyProtocol() {
                const button = this.elements.toggleButton;
                button.disabled = true;
                this.setButtonState('‚è≥', 'Updating...', button.className, true);

                const newEnabled = !this.currentEnabled;

                try {
                    const response = await fetch('./api/toggle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': this.csrfToken
                        },
                        body: JSON.stringify({ enabled: newEnabled })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.result === 'success') {
                        await this.loadStatus();
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error updating configuration: ' + error.message);
                    this.updateToggleButton(this.currentEnabled);
                }
            }
        }

        // Initialize plugin when DOM is loaded
        let pluginInstance;

        function toggleProxyProtocol() {
            if (pluginInstance) {
                pluginInstance.toggleProxyProtocol();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            pluginInstance = new ProxyProtocolPlugin();
        });

        // Fallback for older browsers
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (!pluginInstance) {
                    pluginInstance = new ProxyProtocolPlugin();
                }
            });
        } else {
            pluginInstance = new ProxyProtocolPlugin();
        }
    </script>
</body>
</html>
